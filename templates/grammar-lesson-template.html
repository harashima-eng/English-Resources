<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ========== CUSTOMIZE: Page title ========== -->
  <title>{{LESSON_NUMBER}} {{TOPIC_JP}} | {{TOPIC_EN}}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #faf9f7;
      --bg-warm: #f5f3ef;
      --card: #ffffff;
      --text: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-muted: #999999;
      --border: rgba(0,0,0,0.12);
      --shadow-sm: 0 2px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.06);
      --shadow: 0 4px 20px rgba(0,0,0,0.1);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
      --radius: 20px;
      --radius-sm: 12px;
      /* ========== CUSTOMIZE: Topic colors ========== */
      --primary: #e8725c;
      --primary-light: #fef4f2;
      --secondary: #3d8bca;
      --secondary-light: #f0f7fc;
      --tertiary: #9b7fcf;
      --tertiary-light: #f8f5fc;
      --quaternary: #5a9a6e;
      --quaternary-light: #f3f9f5;
      --accent: #e8725c;
    }
    [data-theme="dark"] {
      --bg: #0d0d0d;
      --bg-warm: #141414;
      --card: #1a1a1a;
      --text: #f5f5f5;
      --text-secondary: #a0a0a0;
      --text-muted: #666666;
      --border: rgba(255,255,255,0.08);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
      --shadow: 0 4px 20px rgba(0,0,0,0.3);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.4);
      --primary-light: rgba(232,114,92,0.12);
      --secondary-light: rgba(61,139,202,0.12);
      --tertiary-light: rgba(155,127,207,0.12);
      --quaternary-light: rgba(90,154,110,0.12);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    #intro, #overview, #study { scroll-margin-top: 52px; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    /* Top Navigation */
    .top-nav {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      background: rgba(250, 249, 247, 0.95);
      border-bottom: 1px solid var(--border);
      padding: 0 24px; height: 52px;
      display: flex; align-items: center; justify-content: space-between;
    }
    [data-theme="dark"] .top-nav { background: rgba(13, 13, 13, 0.95); }
    .top-nav-logo { font-family: 'New York', 'Georgia', serif; font-size: 15px; color: var(--text-secondary); letter-spacing: 0.02em; }
    .top-nav-center { display: flex; gap: 8px; }
    .top-nav-link {
      padding: 8px 20px; font-size: 14px; font-weight: 500;
      color: var(--text-secondary); text-decoration: none;
      border-radius: 100px; transition: all 0.2s ease;
    }
    .top-nav-link:hover { color: var(--text); background: var(--bg-warm); }
    .top-nav-link.active { color: var(--text); background: var(--card); box-shadow: var(--shadow-sm); }
    [data-theme="dark"] .top-nav-link:hover { background: var(--card); }
    .top-nav-theme {
      width: 36px; height: 36px; border-radius: 50%;
      border: 1px solid var(--border); background: var(--card);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 14px; transition: all 0.2s ease;
    }
    .top-nav-theme:hover { transform: scale(1.05); box-shadow: var(--shadow-sm); }

    /* Intro / Hero Section */
    .intro {
      min-height: 100vh; display: flex; flex-direction: column;
      position: relative; overflow: hidden; padding-top: 52px;
    }
    .intro-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-warm); opacity: 0.5; }
    .intro-hero {
      flex: 1; display: flex; flex-direction: column;
      justify-content: center; align-items: center; text-align: center;
      padding: 40px; position: relative; z-index: 10;
    }
    .intro-label {
      font-size: 13px; font-weight: 600; letter-spacing: 0.15em;
      text-transform: uppercase; color: var(--accent); margin-bottom: 24px;
    }
    .intro-title {
      font-family: 'New York', 'Georgia', serif;
      font-size: clamp(64px, 12vw, 140px); font-weight: 400;
      line-height: 1; letter-spacing: -0.03em; margin-bottom: 24px;
    }
    .intro-title em { font-style: italic; color: var(--accent); }
    .intro-subtitle { font-size: 20px; color: var(--text-secondary); max-width: 500px; margin-bottom: 48px; }
    .intro-cta { display: flex; gap: 16px; }
    .btn-primary {
      padding: 16px 32px; background: var(--text); color: var(--bg);
      border: none; border-radius: 100px; font-size: 15px; font-weight: 600;
      font-family: inherit; cursor: pointer; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .btn-secondary {
      padding: 16px 32px; background: transparent; color: var(--text);
      border: 1px solid var(--border); border-radius: 100px;
      font-size: 15px; font-weight: 600; font-family: inherit;
      cursor: pointer; transition: all 0.3s ease;
    }
    .btn-secondary:hover { background: var(--card); border-color: transparent; box-shadow: var(--shadow); }

    /* Study Section */
    .study { padding: 80px 48px; max-width: 1200px; margin: 0 auto; }
    @media (max-width: 600px) { .study { padding: 48px 20px; } }
    .study-header { display: flex; flex-wrap: wrap; align-items: center; gap: 16px; margin-bottom: 32px; }
    .study-title { font-family: 'New York', 'Georgia', serif; font-size: clamp(28px, 5vw, 40px); font-weight: 400; flex: 1; }
    .study-controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .view-toggle { display: flex; background: var(--bg-warm); border-radius: 100px; padding: 4px; }
    .view-btn {
      padding: 8px 16px; border: none; background: transparent;
      border-radius: 100px; font-size: 13px; font-weight: 500;
      font-family: inherit; cursor: pointer; color: var(--text-secondary);
      transition: all 0.2s ease;
    }
    .view-btn.active { background: var(--card); color: var(--text); box-shadow: var(--shadow-sm); }
    .ctrl-btn {
      padding: 8px 16px; border: 1px solid var(--border); background: var(--card);
      border-radius: 100px; font-size: 13px; font-weight: 500;
      font-family: inherit; cursor: pointer; color: var(--text-secondary);
      transition: all 0.2s ease;
    }
    .ctrl-btn:hover { color: var(--text); box-shadow: var(--shadow-sm); }
    .progress-bar { height: 6px; background: var(--bg-warm); border-radius: 3px; margin-bottom: 8px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--quaternary); border-radius: 3px; width: 0%; transition: width 0.3s ease; }
    .progress-text { font-size: 13px; color: var(--text-muted); margin-bottom: 24px; }
    .search-wrapper { position: relative; margin-bottom: 32px; }
    .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    .search-input {
      width: 100%; padding: 14px 16px 14px 44px;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      font-size: 15px; font-family: inherit; background: var(--card);
      color: var(--text); transition: all 0.2s ease;
    }
    .search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(232,114,92,0.1); }

    /* Section Accordion */
    .section { background: var(--card); border-radius: var(--radius); margin-bottom: 16px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); overflow: hidden; }
    .section-header {
      padding: 20px 24px; cursor: pointer; display: flex;
      justify-content: space-between; align-items: center;
      font-weight: 600; font-size: 16px; transition: all 0.2s ease;
    }
    .section-header:hover { background: var(--bg-warm); }
    .section-arrow { transition: transform 0.2s ease; color: var(--text-muted); font-size: 12px; }
    .section-header.open .section-arrow { transform: rotate(180deg); }
    .section-body { display: none; }
    .section-body.open { display: block; border-top: 1px solid var(--border); padding: 20px; }
    .questions-list { display: flex; flex-direction: column; gap: 16px; }

    /* Question Card */
    .qcard { background: var(--bg); border-radius: var(--radius-sm); border: 1px solid var(--border); }
    .qcard-question, .qcard-buttons, .qcard-left, .qcard-right { box-sizing: border-box; }
    .qcard-buttons, .toggle-btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .qcard-buttons { padding: 0 24px 16px; }
    /* Dual/Split view */
    [data-view="dual"] .qcard {
      display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto;
      grid-template-areas: "question question" "left right";
    }
    [data-view="dual"] .qcard-buttons { display: none; }
    [data-view="dual"] .qcard-question { grid-area: question; padding: 24px; border-bottom: 1px solid var(--border); }
    [data-view="dual"] .qcard-left { grid-area: left; padding: 24px; border-right: 1px solid var(--border); }
    [data-view="dual"] .qcard-right { grid-area: right; padding: 24px; background: var(--bg-warm); }
    [data-view="dual"] .collapsible { display: none; }
    [data-view="dual"] .collapsible.open { display: block; margin-top: 16px; }
    /* Single view */
    [data-view="single"] .qcard { display: block; }
    [data-view="single"] .qcard-buttons { display: flex; }
    [data-view="single"] .toggle-btn-row { display: none; }
    [data-view="single"] .qcard-question { padding: 24px 24px 16px; }
    [data-view="single"] .qcard-left { padding: 0 24px 0; border-right: none; }
    [data-view="single"] .qcard-right { padding: 0 24px 24px; background: transparent; }
    [data-view="single"] .collapsible { display: none; }
    [data-view="single"] .collapsible.open { display: block; margin-top: 16px; }
    @media (max-width: 800px) {
      [data-view="dual"] .qcard { grid-template-columns: 1fr; grid-template-areas: "question" "left" "right"; }
      [data-view="dual"] .qcard-left { border-right: none; border-bottom: 1px solid var(--border); }
    }
    .qnum {
      display: inline-block; font-weight: 700; font-size: 12px; color: var(--accent);
      background: var(--primary-light); padding: 4px 12px; border-radius: 100px; margin-bottom: 12px;
    }
    .qtext { font-size: 20px; line-height: 1.8; margin-bottom: 12px; }
    .choices, .scramble { padding: 14px 16px; border-radius: var(--radius-sm); font-size: 19px; }
    .qcard-question .choices:last-child, .qcard-question .scramble:last-child { margin-bottom: 0; }
    .choices { background: var(--tertiary-light); border-left: 3px solid var(--tertiary); }
    .scramble { background: var(--secondary-light); border-left: 3px solid var(--secondary); font-family: 'SF Mono', Monaco, monospace; }
    .toggle-btn {
      flex: 1; min-width: 80px; padding: 10px 16px; border: none; border-radius: 100px;
      font-size: 13px; font-weight: 600; font-family: inherit; cursor: pointer;
      transition: transform 0.15s ease, opacity 0.15s ease;
    }
    .toggle-btn:hover { transform: translateY(-2px); }
    .toggle-btn:active { transform: scale(0.98); }
    .toggle-btn.vocab { background: var(--tertiary); color: white; }
    .toggle-btn.hint { background: var(--primary); color: white; }
    .toggle-btn.answer { background: var(--quaternary); color: white; }
    .collapsible { overflow: hidden; }
    .collapsible.open { /* Animation disabled for performance */ }
    .box { padding: 16px; border-radius: var(--radius-sm); font-size: 18px; line-height: 1.7; }
    .vocab-box { background: var(--tertiary-light); border-left: 3px solid var(--tertiary); }
    .hint-box { background: var(--primary-light); border-left: 3px solid var(--primary); }
    .ans-box { background: var(--quaternary-light); border-left: 3px solid var(--quaternary); }
    .choice-explanations { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(90, 154, 110, 0.2); }
    .choice-exp { padding: 6px 0; font-size: 18px; line-height: 1.6; }
    .choice-exp.correct { color: var(--quaternary); font-weight: 600; }
    .choice-exp.wrong { color: var(--text-secondary); }
    .vocab-item { padding: 6px 0; border-bottom: 1px solid rgba(155,127,207,0.15); }
    .vocab-item:last-child { border-bottom: none; }
    .vocab-word { font-weight: 700; color: var(--tertiary); margin-right: 8px; }
    .box-label { font-weight: 700; font-size: 19px; margin-bottom: 12px; display: block; }
    .jp-text { color: var(--text-secondary); margin-top: 12px; font-size: 18px; }
    .grammar-ref {
      background: var(--secondary-light); border-left: 3px solid var(--secondary);
      padding: 12px 14px; border-radius: var(--radius-sm); font-size: 16px; margin-top: 12px;
    }
    .no-match { display: none !important; }

    /* Footer */
    footer { text-align: center; padding: 40px; color: var(--text-muted); font-size: 13px; border-top: 1px solid var(--border); }

    /* FAB */
    .fab {
      position: fixed; bottom: 32px; right: 32px; width: 56px; height: 56px;
      border-radius: 50%; background: var(--text); color: var(--bg); border: none;
      cursor: pointer; font-size: 24px; box-shadow: var(--shadow-lg); z-index: 100;
    }
  </style>
</head>
<body data-view="single">
  <!-- Top Navigation -->
  <nav class="top-nav">
    <!-- ========== CUSTOMIZE: Logo text ========== -->
    <div class="top-nav-logo">DUAL SCOPE</div>
    <div class="top-nav-center">
      <a href="#intro" class="top-nav-link active" data-section="intro">Start</a>
      <a href="#study" class="top-nav-link" data-section="study">Questions</a>
    </div>
    <button class="top-nav-theme" onclick="toggleTheme()" title="Toggle theme">
      <span class="theme-icon">‚òÄÔ∏è</span>
    </button>
  </nav>

  <!-- Intro Section -->
  <section class="intro" id="intro">
    <div class="intro-bg"></div>
    <div class="intro-hero">
      <!-- ========== CUSTOMIZE: Lesson info ========== -->
      <div class="intro-label">Lesson {{LESSON_NUMBER}}</div>
      <h1 class="intro-title">{{TOPIC_JP}}</h1>
      <p class="intro-subtitle">{{SUBTITLE}}</p>
      <div class="intro-cta">
        <button class="btn-primary" onclick="scrollToStudy()">Start Learning</button>
      </div>
    </div>
  </section>

  <!-- Study Section -->
  <section class="study" id="study">
    <div class="study-header">
      <h2 class="study-title">Practice Questions</h2>
      <div class="study-controls">
        <div class="view-toggle">
          <button class="view-btn active" data-view="single" onclick="setView('single')">Single</button>
          <button class="view-btn" data-view="dual" onclick="setView('dual')">Split View</button>
        </div>
        <button class="ctrl-btn" onclick="openAll()">Open All</button>
        <button class="ctrl-btn" onclick="closeAll()">Close All</button>
      </div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
    <!-- ========== CUSTOMIZE: Total question count ========== -->
    <div class="progress-text" id="progressText">0 / {{TOTAL_QUESTIONS}} answers revealed</div>
    <div class="search-wrapper">
      <span class="search-icon">üîç</span>
      <input type="text" class="search-input" id="searchInput" placeholder="Search questions, grammar, vocabulary..." oninput="debouncedSearch()">
    </div>
    <div id="content"></div>
  </section>

  <!-- ========== CUSTOMIZE: Footer ========== -->
  <footer>DUAL SCOPE English Grammar ‚Äî Lesson {{LESSON_NUMBER}}: {{TOPIC_JP}}</footer>

  <button class="fab" onclick="scrollToTop()" title="Back to top">‚Üë</button>

<script>
// ========== CUSTOMIZE: Grammar Data ==========
// This is where you add all your questions
const grammarData = {
  sections: [
    {
      title: "[1] Section Title Here",
      open: true,  // First section opens by default
      questions: [
        // EXAMPLE: Multiple Choice Question
        {
          num: "(1)",
          text: "Question text with (   ) blank.",
          choices: "a. option1  b. option2  c. option3  d. option4",
          vocab: [["word", "meaning"], ["word2", "meaning2"]],
          hint: ["Hint line 1", "Hint line 2"],
          answer: "b. option2",
          translation: "Japanese translation here",
          explanation: "Explanation in Japanese",
          grammar: "Grammar pattern explanation",
          choiceExplanations: {
            "a. option1": "√ó Why this is wrong",
            "b. option2": "‚óã Why this is correct",
            "c. option3": "√ó Why this is wrong",
            "d. option4": "√ó Why this is wrong"
          }
        },
        // EXAMPLE: Scramble Question
        {
          num: "(2)",
          text: "Japanese instruction here",
          scramble: "English sentence [ word1, word2, word3, word4 ] to arrange.",
          vocab: [["word", "meaning"]],
          hint: ["Arrangement hint"],
          answer: "word2 word1 word4 word3",
          explanation: "Explanation here",
          grammar: "Grammar pattern"
        },
        // EXAMPLE: Translation Question (no choices/scramble)
        {
          num: "(3)",
          text: "English sentence to translate or analyze.",
          vocab: [["key word", "meaning"]],
          translation: "Japanese translation",
          explanation: "Explanation",
          grammar: "Grammar pattern",
          answer: "(Translation question)"
        }
      ]
    },
    {
      title: "[2] Another Section",
      open: false,
      questions: [
        // Add more questions here
      ]
    }
  ]
};

// Render functions
function renderQuestion(q) {
  let questionHtml = `<div class="qcard-question">
    <span class="qnum">${q.num}</span>
    <div class="qtext">${q.text}</div>`;
  if (q.choices) questionHtml += `<div class="choices">${q.choices}</div>`;
  if (q.scramble) questionHtml += `<div class="scramble">${q.scramble}</div>`;
  questionHtml += `</div>`;

  let btnHtml = `<div class="qcard-buttons">
    <button class="toggle-btn vocab" onclick="toggle(this,'vocab')">Words</button>`;
  if (q.hint) btnHtml += `<button class="toggle-btn hint" onclick="toggle(this,'hint')">Hint</button>`;
  btnHtml += `<button class="toggle-btn answer" onclick="toggle(this,'answer')">Answer</button></div>`;

  let leftHtml = `<div class="qcard-left">
    <div class="toggle-btn-row">
      <button class="toggle-btn vocab" onclick="toggle(this,'vocab')">Words</button>`;
  if (q.hint) leftHtml += `<button class="toggle-btn hint" onclick="toggle(this,'hint')">Hint</button>`;
  leftHtml += `</div>`;
  if (q.vocab) {
    leftHtml += `<div class="collapsible" data-type="vocab"><div class="box vocab-box">`;
    q.vocab.forEach(v => leftHtml += `<div class="vocab-item"><span class="vocab-word">${v[0]}</span>${v[1]}</div>`);
    leftHtml += `</div></div>`;
  }
  if (q.hint) {
    leftHtml += `<div class="collapsible" data-type="hint"><div class="box hint-box"><span class="box-label">Hint</span>`;
    q.hint.forEach(h => leftHtml += `<div>‚Üí ${h}</div>`);
    leftHtml += `</div></div>`;
  }
  leftHtml += `</div>`;

  let rightHtml = `<div class="qcard-right">
    <div class="toggle-btn-row">
      <button class="toggle-btn answer" onclick="toggle(this,'answer')">Answer</button>
    </div>
    <div class="collapsible" data-type="answer"><div class="box ans-box">
      <span class="box-label">Answer: ${q.answer}</span>`;
  if (q.translation) rightHtml += `<div class="jp-text">${q.translation}</div>`;
  if (q.explanation) rightHtml += `<div class="jp-text">${q.explanation}</div>`;
  if (q.choiceExplanations) {
    rightHtml += `<div class="choice-explanations">`;
    for (const [choice, exp] of Object.entries(q.choiceExplanations)) {
      const isCorrect = q.answer.includes(choice);
      rightHtml += `<div class="choice-exp ${isCorrect ? 'correct' : 'wrong'}">${exp}</div>`;
    }
    rightHtml += `</div>`;
  }
  if (q.grammar) rightHtml += `<div class="grammar-ref">${q.grammar}</div>`;
  rightHtml += `</div></div></div>`;

  return `<div class="qcard">${questionHtml}${btnHtml}${leftHtml}${rightHtml}</div>`;
}

function renderSection(section, index) {
  let html = `<div class="section" data-section="${index}">
    <div class="section-header ${section.open ? 'open' : ''}" onclick="toggleSection(this)">
      <span>${section.title}</span>
      <span class="section-arrow">‚ñº</span>
    </div>
    <div class="section-body ${section.open ? 'open' : ''}">
      <div class="questions-list">`;
  section.questions.forEach(q => html += renderQuestion(q));
  html += `</div></div></div>`;
  return html;
}

function init() {
  let html = '';
  grammarData.sections.forEach((s, i) => html += renderSection(s, i));
  document.getElementById('content').innerHTML = html;
}

// Event handlers
function toggle(btn, type) {
  const card = btn.closest('.qcard');
  const block = card.querySelector(`.collapsible[data-type="${type}"]`);
  if (block) {
    block.classList.toggle('open');
    updateProgress();
  }
}

function toggleSection(header) {
  header.classList.toggle('open');
  header.nextElementSibling.classList.toggle('open');
}

function openAll() {
  document.querySelectorAll('.section-header').forEach(h => {
    h.classList.add('open');
    h.nextElementSibling.classList.add('open');
  });
}

function closeAll() {
  document.querySelectorAll('.section-header').forEach(h => {
    h.classList.remove('open');
    h.nextElementSibling.classList.remove('open');
    h.nextElementSibling.querySelectorAll('.collapsible').forEach(c => c.classList.remove('open'));
  });
  updateProgress();
}

function setView(view) {
  document.body.setAttribute('data-view', view);
  try { localStorage.setItem('viewMode', view); } catch(e) {}
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-view') === view);
  });
}

let cachedTotal = 0;
function updateProgress() {
  if (!cachedTotal) {
    cachedTotal = document.querySelectorAll('.collapsible[data-type="answer"]').length;
  }
  const revealed = document.querySelectorAll('.collapsible[data-type="answer"].open').length;
  const pct = cachedTotal > 0 ? Math.round((revealed / cachedTotal) * 100) : 0;
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressText').textContent = `${revealed} / ${cachedTotal} answers revealed`;
}

let searchTimeout = null;
function debouncedSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(handleSearch, 150);
}

function handleSearch() {
  const query = document.getElementById('searchInput').value.toLowerCase().trim();
  if (!query) {
    document.querySelectorAll('.qcard, .section').forEach(el => el.classList.remove('no-match'));
    return;
  }
  grammarData.sections.forEach((section, si) => {
    const sectionEl = document.querySelector(`[data-section="${si}"]`);
    let hasMatch = false;
    section.questions.forEach((q, qi) => {
      const text = [q.text || '', q.choices || '', q.scramble || '', q.answer || '', q.translation || '', q.grammar || '', (q.vocab || []).flat().join(' '), (q.hint || []).join(' ')].join(' ').toLowerCase();
      const cards = sectionEl.querySelectorAll('.qcard');
      const card = cards[qi];
      if (text.includes(query)) {
        card.classList.remove('no-match');
        hasMatch = true;
      } else {
        card.classList.add('no-match');
      }
    });
    sectionEl.classList.toggle('no-match', !hasMatch);
    if (hasMatch) {
      sectionEl.querySelector('.section-header').classList.add('open');
      sectionEl.querySelector('.section-body').classList.add('open');
    }
  });
}

function toggleTheme() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
  try { localStorage.setItem('theme', isDark ? 'light' : 'dark'); } catch(e) {}
  document.querySelector('.theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
}

function scrollToStudy() {
  document.getElementById('study').scrollIntoView({ behavior: 'smooth' });
}

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Init
window.addEventListener('DOMContentLoaded', () => {
  init();
  try {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.querySelector('.theme-icon').textContent = 'üåô';
    }
    const savedView = localStorage.getItem('viewMode') || 'single';
    setView(savedView);
  } catch(e) {}
  updateProgress();
});
</script>
</body>
</html>
